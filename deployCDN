#!/bin/bash

username="cdn_project_dileep_nikhil"
keyfile="/home/nikhil/.ssh/id_rsa"
dns_server_ip_address="97.107.140.73"
dns_build_path="/home/$username/p4_build"
old_path="/home/$username/dns_build"
projectpath="/CS5700_Project4_OwnCDN"
dns_files_to_copy=(dnsserver.py cdn res dns-hosts.txt dnsserver)
https_files_to_copy=(httpserver.py httpreq httpserver utils replicas.txt Makefile)
port=$2
origin=$4
name=$6
username=$8
keyfile=${10}

#echo "Deploying the CDN to $dns_server_ip_address"
#
#echo "Removing the old build directory"
#ssh -o "StrictHostKeyChecking no" -i $keyfile $username@$dns_server_ip_address rm -rf $dns_build_path ;
#echo "Creating the new build directory"
#ssh -o "StrictHostKeyChecking no" -i $keyfile $username@$dns_server_ip_address mkdir -p $dns_build_path ;
#
#for file in "${dns_files_to_copy[@]}"; do
#  echo "Copying $file to $dns_dns_build_path"
#    scp -o "StrictHostKeyChecking no" -i "$keyfile" -r "$file" "$username"@$dns_server_ip_address:$dns_build_path ;
#
#  echo "File copying is done!"
#done

## Make the zip file of the source code and upload it to the dns server.
#file_name="p4.zip"
#
## Read the dns server IP address from the dns-hosts.txt file and copy the source code to the dns server.
# shellcheck disable=SC2095
while IFS= read -r ip; do

  #echo "Copying source code to $ip"

  #skip if empty
  if [[ -z "$ip" ]]; then
    continue
  fi

  #echo "Deploying to the replica server at $ip2"

  #echo "Removing the old build directory"

  until ssh -o "StrictHostKeyChecking no" -i "$keyfile" $username@$ip rm -rf $dns_build_path ; do
    sleep 1
    done

  #echo "Creating the new build directory"

  until ssh -o "StrictHostKeyChecking no" -i "$keyfile" $username@$ip mkdir -p $dns_build_path ; do
    sleep 1
    done


  # shellcheck disable=SC1073
  for file in "${https_files_to_copy[@]}";do
    until scp -o "StrictHostKeyChecking no" -i "$keyfile" -r "$file" $username@$ip:$dns_build_path ; do
      sleep 1
      done
    #echo "Copying $file done!!"
  done
done < replicas.txt

#  echo "Removing the old build directory"
#
#  ssh -o "StrictHostKeyChecking no" -i "$keyfile" "$username"@139.144.30.25 rm -rf $dns_build_path ;
#
#  echo "Creating the new build directory"
#
#  ssh -o "StrictHostKeyChecking no" -i "$keyfile" "$username"@139.144.30.25 mkdir -p $dns_build_path ;
#
#  for file in "${https_files_to_copy[@]}";do
#    echo "Copying $file to $ip"
#    scp -o "StrictHostKeyChecking no" -i "$keyfile" -r "$file" "$username"@139.144.30.25:$dns_build_path ;
#    echo "Copying $file done!!"
#  done